## django-blog-tutorial


## 環境構築手順

仮想環境作成

```bash
% python -m venv .venv && source .venv/bin/activate
```

コンテナ起動(posgre, redis)
```bash
% docker-compose up -d
```

依存関係のインストール
```bash
% pip install -r requirements.txt
```

開発サーバー起動

```bash
% python manage.py runserver 0.0.0.0:18000
```


http://localhost:18000/にアクセス

django_blogという名称のDBをpgadminから作成し、マイグレーション

```bash
python manage.py migrate
```

## 新しいアプリケーションの作成

アプリケーションの作成

```bash
python manage.py startapp <appname>
```

settings.pyのINSTALLED_APPSに追記すると、プロジェクトに追加できる
```python
INSTALLED_APPS = [
    'polls.apps.PollsConfig',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
```

マイグレーション作成

```bash
python manage.py makemigrations <appname>
```


## マイグレーション関連

### マイグレーションファイルから生のsqlを確認

```bash
# migrations/0001_initial.py
python manage.py sqlmigrate <appname> 0001
```

以下のようなsqlが取得できる

``` sql
BEGIN;
--
-- Create model Comment
--
CREATE TABLE "comments_comment" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "comment_text" text NOT NULL, "article_id" bigint NOT NULL);
ALTER TABLE "comments_comment" ADD CONSTRAINT "comments_comment_article_id_94fe60a2_fk_articles_article_id" FOREIGN KEY ("article_id") REFERENCES "articles_article" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "comments_comment_article_id_94fe60a2" ON "comments_comment" ("article_id");
COMMIT;
```

## テスト
### テスト実行
アプリケーション内にあるテストを探索

```
python manage.py test <appname>
```

### 種類
- ビュー
- ユースケース
- リポジトリ
- 汎用クラス、関数
- その他(ビジネスロジックを含むドメインクラス、シリアライザーとか)

#### ビュー
- APIへのリクエスト権限、アクセス制御のテスト
- 指定したリクエストと期待するレスポンスのブラックボックステスト

#### ユースケース
- ユースケースに作成したpublicメソッドの正常系、異常系のテスト
- トランザクションが必要な処理であれば、そのテスト

#### リポジトリ
リポジトリに作成したpublicメソッドの正常系、異常系のテスト

#### 汎用クラス、関数
shared等に配置した共通クラス、関数のテスト

## Python全般のVSCode拡張機能
自動インポート、コード補完、構文チェック
[microsoft公式の拡張機能](https://marketplace.visualstudio.com/items?itemName=ms-python.python)をインストールする

### リンターの設定
型チェックなど
```json
// strictだと型に厳しすぎるので、basicで指定
"python.analysis.typeCheckingMode": "basic",
```

## フォーマッター
- [Prettierでフォーマットするプラグイン](https://github.com/prettier/plugin-python)のメンテナンスがしばらくされてないようなので、Blackを使用する

### 導入手順
1. [VSCode拡張機能](https://marketplace.visualstudio.com/items?itemName=ms-python.black-formatter)をインストールする
2. settings.jsonに以下を追記
```json
 "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter",
    "editor.formatOnSave": true
  },
```

1. blackを依存関係に追加する(これは1回きり)
2. .pyファイルを保存してフォーマットが効いていれば設定完了
   1. 以下の折り返しの設定を追加してみて、設定した数で折り返せば反映できている
   2. 折り返しの設定は実際に使用する際は特に不要なので、反映が確認できたら消しておく

```json
"[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter",
    "editor.formatOnSave": true
  },
  // 極端に少ない数とかにしてフォーマットが効くか試してみてください
  "black-formatter.args": [
    "--line-length=10"
  ],
```